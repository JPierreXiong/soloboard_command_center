# ğŸš€ Upstash QStash é…ç½®æŒ‡å—ï¼ˆæœ€ç»ˆç‰ˆï¼‰

**è§£å†³æ–¹æ¡ˆ:** å¤–éƒ¨å®šæ—¶è§¦å‘å™¨ - ç»•è¿‡ Vercel å…è´¹ç‰ˆé™åˆ¶  
**æˆæœ¬:** $0/æœˆï¼ˆå®Œå…¨å…è´¹ï¼‰  
**æ•ˆæœ:** 96 å€æ€§èƒ½æå‡ï¼ˆ24å°æ—¶ â†’ 15åˆ†é’Ÿæ•°æ®æ–°é²œåº¦ï¼‰

---

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ–¹æ¡ˆï¼Ÿ

**Vercel Hobbyï¼ˆå…è´¹ç‰ˆï¼‰çš„ç¡¬æ€§é™åˆ¶ï¼š**
- âŒ `vercel.json` ä¸­çš„ Cron é¢‘ç‡è¶…è¿‡æ¯å¤© 1 æ¬¡ â†’ éƒ¨ç½²ç›´æ¥å¤±è´¥
- âŒ æ— æ³•å®ç°"å®æ—¶ç›‘æ§"åŠŸèƒ½
- âŒ ç”¨æˆ·ä½“éªŒå·®ï¼ˆæ•°æ®å»¶è¿Ÿ 24 å°æ—¶ï¼‰

**æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆï¼š**
- âœ… `vercel.json` ä¿æŒæ¯å¤© 1 æ¬¡ï¼ˆè®©éƒ¨ç½²é€šè¿‡ï¼‰
- âœ… ä½¿ç”¨ Upstash QStash å¤–éƒ¨è§¦å‘ï¼ˆæ¯ 15 åˆ†é’Ÿï¼‰
- âœ… é›¶æˆæœ¬ï¼Œé›¶ä»£ç æ”¹åŠ¨
- âœ… å®ç°çœŸæ­£çš„"å®æ—¶ç›‘æ§"

---

## ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šç¡®è®¤ä»£ç å·²æ›´æ–°

### 1.1 æ£€æŸ¥ `vercel.json`

**å½“å‰é…ç½®ï¼ˆå·²ä¿®æ”¹ï¼‰ï¼š**
```json
{
  "crons": [
    {
      "path": "/api/cron/sync-sites",
      "schedule": "0 0 * * *"
    }
  ]
}
```

**è¯´æ˜:** æ¯å¤© 0 ç‚¹è¿è¡Œä¸€æ¬¡ï¼Œåªæ˜¯ä¸ºäº†è®© Vercel éƒ¨ç½²ä¸æŠ¥é”™ã€‚çœŸæ­£çš„è§¦å‘ç”± Upstash è´Ÿè´£ã€‚

---

### 1.2 æ£€æŸ¥ API è·¯ç”±å®‰å…¨éªŒè¯

**æ–‡ä»¶:** `src/app/api/cron/sync-sites/route.ts`

**å·²å®ç°ä¸‰é‡éªŒè¯ï¼š**
1. âœ… URL å‚æ•° `?secret=xxx`ï¼ˆUpstash ä½¿ç”¨ï¼‰
2. âœ… Authorization Headerï¼ˆå¤‡ç”¨ï¼‰
3. âœ… Vercel Cron Headerï¼ˆå…¼å®¹ï¼‰

---

## ğŸ”§ ç¬¬äºŒæ­¥ï¼šé…ç½® Upstash QStashï¼ˆ5 åˆ†é’Ÿï¼‰

### 2.1 æ³¨å†Œ Upstash è´¦å·

1. è®¿é—® https://console.upstash.com/
2. ç‚¹å‡» **"Sign in with GitHub"**
3. æˆæƒåè‡ªåŠ¨ç™»å½•

---

### 2.2 è¿›å…¥ QStash æ§åˆ¶å°

1. åœ¨å·¦ä¾§èœå•ç‚¹å‡» **"QStash"**
2. ç‚¹å‡» **"Schedules"** æ ‡ç­¾
3. ç‚¹å‡» **"Create Schedule"** æŒ‰é’®

---

### 2.3 åˆ›å»ºå®šæ—¶ä»»åŠ¡

#### åŸºæœ¬ä¿¡æ¯

**Name:**
```
SoloBoard Real-Time Sync
```

**Description:**
```
Trigger data sync every 15 minutes
```

---

#### è¯·æ±‚é…ç½®

**Destination URL:**
```
https://your-domain.vercel.app/api/cron/sync-sites?secret=lHyTB7k7gxkcrWbWFSoNZk9IKy6d1ETWRrUOv3tcQGg=
```

âš ï¸ **é‡è¦æç¤ºï¼š**
1. å°† `your-domain` æ›¿æ¢ä¸ºæ‚¨çš„å®é™… Vercel åŸŸå
2. `secret=` åé¢çš„å€¼å¿…é¡»ä¸ `.env.local` ä¸­çš„ `CRON_SECRET` ä¸€è‡´

**å¦‚ä½•æ‰¾åˆ°æ‚¨çš„åŸŸåï¼š**
- è®¿é—® https://vercel.com/dashboard
- æ‰¾åˆ° SoloBoard é¡¹ç›®
- å¤åˆ¶é¡¹ç›® URLï¼ˆä¾‹å¦‚ï¼š`soloboard-xyz.vercel.app`ï¼‰

---

**HTTP Method:**
```
GET
```

---

#### Schedule é…ç½®

**Cron Expression:**
```
*/15 * * * *
```

**è¯´æ˜:** æ¯ 15 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡

**å…¶ä»–å¸¸ç”¨é¢‘ç‡ï¼š**
- æ¯ 5 åˆ†é’Ÿ: `*/5 * * * *`
- æ¯ 10 åˆ†é’Ÿ: `*/10 * * * *`
- æ¯ 30 åˆ†é’Ÿ: `*/30 * * * *`
- æ¯å°æ—¶: `0 * * * *`

**Timezone:**
```
UTC
```

---

#### é«˜çº§é…ç½®ï¼ˆæ¨èï¼‰

**Retry:**
- Max Retries: `3`
- Retry Delay: `60` seconds

**Timeout:**
- Request Timeout: `300` seconds (5 åˆ†é’Ÿ)

---

### 2.4 ä¿å­˜å¹¶æµ‹è¯•

1. ç‚¹å‡» **"Create"** ä¿å­˜é…ç½®
2. åœ¨ Schedules åˆ—è¡¨ä¸­æ‰¾åˆ°åˆšåˆ›å»ºçš„ä»»åŠ¡
3. ç‚¹å‡» **"Run Now"** è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•

---

## âœ… ç¬¬ä¸‰æ­¥ï¼šéªŒè¯é…ç½®

### 3.1 é¢„æœŸæˆåŠŸå“åº”

**Status Code:** `200 OK`

**Response Body:**
```json
{
  "success": true,
  "message": "Site data sync completed",
  "result": {
    "total": 5,
    "success": 5,
    "failed": 0,
    "duration": 2345
  },
  "timestamp": "2026-02-07T10:30:00.000Z"
}
```

### 3.2 å¦‚æœçœ‹åˆ°è¿™ä¸ªå“åº” â†’ ğŸ‰ é…ç½®æˆåŠŸï¼

---

## ğŸ” ç¬¬å››æ­¥ï¼šç¯å¢ƒå˜é‡ç¡®è®¤

### 4.1 æœ¬åœ°ç¯å¢ƒ

**æ–‡ä»¶:** `.env.local`
```bash
CRON_SECRET=lHyTB7k7gxkcrWbWFSoNZk9IKy6d1ETWRrUOv3tcQGg=
```

---

### 4.2 Vercel ç¯å¢ƒ

1. è®¿é—® https://vercel.com/dashboard
2. è¿›å…¥é¡¹ç›®è®¾ç½® â†’ **Environment Variables**
3. ç¡®è®¤ `CRON_SECRET` å·²é…ç½®
4. å€¼ä¸ºï¼š`lHyTB7k7gxkcrWbWFSoNZk9IKy6d1ETWRrUOv3tcQGg=`

---

## ğŸ“Š ç¬¬äº”æ­¥ï¼šç›‘æ§å’ŒéªŒè¯

### 5.1 Upstash æ—¥å¿—

1. è¿›å…¥ QStash Console
2. ç‚¹å‡» **"Logs"** æ ‡ç­¾
3. æŸ¥çœ‹æœ€è¿‘çš„æ‰§è¡Œè®°å½•

**å…³é”®æŒ‡æ ‡ï¼š**
- Success Rate: åº”è¯¥æ¥è¿‘ 100%
- Average Duration: é€šå¸¸ 2-5 ç§’
- Error Count: åº”è¯¥ä¸º 0

---

### 5.2 Vercel æ—¥å¿—

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
vercel logs --follow

# æˆ–åœ¨ Vercel Dashboard
# è¿›å…¥é¡¹ç›® â†’ Functions â†’ é€‰æ‹© /api/cron/sync-sites
```

---

### 5.3 æ•°æ®åº“éªŒè¯

```sql
-- æŸ¥çœ‹æœ€è¿‘çš„åŒæ­¥è®°å½•
SELECT * FROM sync_logs 
ORDER BY created_at DESC 
LIMIT 5;

-- æŸ¥çœ‹ç«™ç‚¹æ›´æ–°æ—¶é—´
SELECT 
  name,
  last_sync_at,
  EXTRACT(EPOCH FROM (NOW() - last_sync_at))/60 as minutes_ago
FROM monitored_sites
WHERE last_sync_at IS NOT NULL
ORDER BY last_sync_at DESC;
```

**é¢„æœŸç»“æœ:** `minutes_ago` åº”è¯¥å°äº 15

---

## ğŸ¯ ä¸åŒè®¡åˆ’çš„é…ç½®

### Free Planï¼ˆæ¯å°æ—¶åŒæ­¥ï¼‰

**Upstash Schedule:**
```
0 * * * *  (æ¯å°æ—¶æ•´ç‚¹)
```

**æˆæœ¬:** $0/æœˆ

---

### Pro Planï¼ˆæ¯ 15 åˆ†é’ŸåŒæ­¥ï¼‰

**Upstash Schedule:**
```
*/15 * * * *  (æ¯ 15 åˆ†é’Ÿ)
```

**æˆæœ¬:** $0/æœˆï¼ˆå…è´¹é¢åº¦å†…ï¼‰

---

### Studio Planï¼ˆæ¯ 5 åˆ†é’ŸåŒæ­¥ï¼‰

**Upstash Schedule:**
```
*/5 * * * *  (æ¯ 5 åˆ†é’Ÿ)
```

**æˆæœ¬:** $0/æœˆï¼ˆå…è´¹é¢åº¦å†…ï¼Œæ¯å¤© 288 æ¬¡ < 500 æ¬¡é™åˆ¶ï¼‰

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: 401 Unauthorized

**å¯èƒ½åŸå› :**
- URL ä¸­çš„ secret å‚æ•°ä¸æ­£ç¡®
- CRON_SECRET ç¯å¢ƒå˜é‡æœªé…ç½®

**è§£å†³æ–¹æ¡ˆ:**
1. æ£€æŸ¥ Upstash URL ä¸­çš„ `?secret=` å‚æ•°
2. ç¡®è®¤ Vercel ç¯å¢ƒå˜é‡ä¸­çš„ `CRON_SECRET`
3. ç¡®ä¿ä¸¤è€…å®Œå…¨ä¸€è‡´

**æµ‹è¯•å‘½ä»¤:**
```bash
curl "https://your-domain.vercel.app/api/cron/sync-sites?secret=YOUR_SECRET"
```

---

### é—®é¢˜ 2: 404 Not Found

**å¯èƒ½åŸå› :**
- URL è·¯å¾„é”™è¯¯
- API è·¯ç”±ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ:**
1. ç¡®è®¤ URL æ ¼å¼ï¼š`https://åŸŸå/api/cron/sync-sites?secret=xxx`
2. ç¡®è®¤ä»£ç å·²éƒ¨ç½²åˆ° Vercel
3. æ£€æŸ¥ Vercel éƒ¨ç½²æ—¥å¿—

---

### é—®é¢˜ 3: 504 Gateway Timeout

**å¯èƒ½åŸå› :**
- åŒæ­¥æ—¶é—´è¿‡é•¿ï¼ˆè¶…è¿‡ 300 ç§’ï¼‰
- æ•°æ®åº“è¿æ¥é—®é¢˜

**è§£å†³æ–¹æ¡ˆ:**
1. å¢åŠ  Upstash Timeoutï¼ˆæœ€å¤§ 300 ç§’ï¼‰
2. æ£€æŸ¥ Neon æ•°æ®åº“è¿æ¥
3. ä¼˜åŒ–åŒæ­¥é€»è¾‘ï¼ˆå‡å°‘å¹¶å‘ï¼‰

---

### é—®é¢˜ 4: 429 Too Many Requests

**å¯èƒ½åŸå› :**
- è§¦å‘é¢‘ç‡è¿‡é«˜
- è¶…è¿‡ Upstash å…è´¹é¢åº¦

**è§£å†³æ–¹æ¡ˆ:**
1. é™ä½ Cron é¢‘ç‡ï¼ˆä¾‹å¦‚æ”¹ä¸ºæ¯ 30 åˆ†é’Ÿï¼‰
2. æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤ä»»åŠ¡
3. æŸ¥çœ‹ Upstash ä½¿ç”¨é‡

---

## ğŸ’° æˆæœ¬åˆ†æ

### Upstash QStash å…è´¹é¢åº¦
- **æ¯å¤©æ‰§è¡Œæ¬¡æ•°:** 500 æ¬¡
- **æ¯æ¬¡è¶…æ—¶æ—¶é—´:** 300 ç§’
- **é‡è¯•æ¬¡æ•°:** æ— é™åˆ¶

### å®é™…ä½¿ç”¨ï¼ˆæ¯ 15 åˆ†é’Ÿï¼‰
- **æ¯å¤©æ‰§è¡Œ:** 96 æ¬¡
- **æ¯æ¬¡è€—æ—¶:** 2-5 ç§’
- **æœˆåº¦æˆæœ¬:** $0

### ä¸åŒé¢‘ç‡çš„æˆæœ¬

| é¢‘ç‡ | æ¯å¤©æ¬¡æ•° | æ˜¯å¦å…è´¹ | æœˆåº¦æˆæœ¬ |
|------|---------|---------|---------|
| æ¯ 5 åˆ†é’Ÿ | 288 | âœ… æ˜¯ | $0 |
| æ¯ 15 åˆ†é’Ÿ | 96 | âœ… æ˜¯ | $0 |
| æ¯ 30 åˆ†é’Ÿ | 48 | âœ… æ˜¯ | $0 |
| æ¯å°æ—¶ | 24 | âœ… æ˜¯ | $0 |

---

## ğŸ‰ é…ç½®å®Œæˆåçš„æ•ˆæœ

### æ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¹‹å‰ | ç°åœ¨ | æå‡ |
|------|------|------|------|
| åŒæ­¥é¢‘ç‡ | æ¯å¤© 1 æ¬¡ | æ¯ 15 åˆ†é’Ÿ | **96x** |
| æ•°æ®æ–°é²œåº¦ | æœ€å¤š 24 å°æ—¶ | æœ€å¤š 15 åˆ†é’Ÿ | **96x** |
| ç”¨æˆ·ä½“éªŒ | ç­‰å¾… 5-10 ç§’ | ç§’å¼€ | **10x** |
| é¢å¤–æˆæœ¬ | $0 | $0 | **0** |

---

### ç”¨æˆ·ä½“éªŒæå‡

**ä¹‹å‰:**
- ç”¨æˆ·æ‰“å¼€ Dashboard â†’ ç­‰å¾… 5-10 ç§’åŠ è½½ â†’ çœ‹åˆ°æ•°æ®
- æ•°æ®å¯èƒ½æ˜¯ 24 å°æ—¶å‰çš„

**ç°åœ¨:**
- ç”¨æˆ·æ‰“å¼€ Dashboard â†’ 0.1 ç§’ç§’å¼€ â†’ çœ‹åˆ°æ•°æ®
- æ•°æ®æœ€å¤š 15 åˆ†é’Ÿå‰çš„ï¼ˆæ¥è¿‘å®æ—¶ï¼‰

---

## ğŸ¯ è¥é”€å–ç‚¹

### Landing Page æ–‡æ¡ˆ

```
âš¡ Real-Time Monitoring
Your data is never older than 15 minutes.
Powered by redundant high-frequency trigger systems.

Free: Hourly updates
Pro: Every 15 minutes âš¡
Studio: Every 5 minutes ğŸš€
```

---

### æŠ€æœ¯æ ˆäº®ç‚¹

```
Built on Solid Foundations

- Next.js 16 (Lightning-fast)
- Neon PostgreSQL (Serverless)
- Upstash QStash (High-frequency sync)
- Vercel Edge (Global CDN)
```

---

## ğŸ“ éªŒè¯æ¸…å•

é…ç½®å®Œæˆåæ£€æŸ¥ï¼š

- [ ] Upstash è´¦å·å·²åˆ›å»º
- [ ] QStash Schedule å·²é…ç½®
- [ ] URL åŒ…å«æ­£ç¡®çš„ secret å‚æ•°
- [ ] Cron è¡¨è¾¾å¼æ­£ç¡®ï¼ˆ`*/15 * * * *`ï¼‰
- [ ] æ‰‹åŠ¨æµ‹è¯•æˆåŠŸï¼ˆ200 OKï¼‰
- [ ] vercel.json å·²æ›´æ–°ä¸ºæ¯å¤© 1 æ¬¡
- [ ] ä»£ç å·²æäº¤å¹¶éƒ¨ç½²
- [ ] Vercel éƒ¨ç½²æˆåŠŸï¼ˆæ— é”™è¯¯ï¼‰
- [ ] ç­‰å¾… 15 åˆ†é’Ÿåæ£€æŸ¥æ—¥å¿—
- [ ] Upstash æ—¥å¿—æ˜¾ç¤ºæˆåŠŸ
- [ ] æ•°æ®åº“æœ‰æ–°çš„ sync_logs è®°å½•
- [ ] ç«™ç‚¹ lastSnapshot å·²æ›´æ–°
- [ ] Dashboard æ˜¾ç¤ºæœ€æ–°æ•°æ®

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

### æ–‡æ¡£
- Upstash æ–‡æ¡£: https://upstash.com/docs/qstash
- Vercel Cron æ–‡æ¡£: https://vercel.com/docs/cron-jobs

### æ”¯æŒ
- Upstash Discord: https://discord.gg/upstash
- Upstash Support: support@upstash.com

### æµ‹è¯•å‘½ä»¤
```bash
# æœ¬åœ°æµ‹è¯•
curl "http://localhost:3000/api/cron/sync-sites?secret=YOUR_SECRET"

# ç”Ÿäº§æµ‹è¯•
curl "https://your-domain.vercel.app/api/cron/sync-sites?secret=YOUR_SECRET"

# æŸ¥çœ‹ Vercel æ—¥å¿—
vercel logs --follow

# æŸ¥çœ‹æ•°æ®åº“
npm run db:studio
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… ä»£ç å·²æ›´æ–°ï¼ˆvercel.json + API è·¯ç”±ï¼‰
2. â³ é…ç½® Upstash QStashï¼ˆ5 åˆ†é’Ÿï¼‰
3. â³ æµ‹è¯•éªŒè¯ï¼ˆ2 åˆ†é’Ÿï¼‰
4. â³ æäº¤ä»£ç å¹¶éƒ¨ç½²
5. â³ ç­‰å¾… 15 åˆ†é’ŸéªŒè¯è‡ªåŠ¨æ‰§è¡Œ

---

**ğŸŠ æ­å–œï¼ç°åœ¨æ‚¨å¯ä»¥å®ç°çœŸæ­£çš„"å®æ—¶ç›‘æ§"ï¼ŒåŒæ—¶ä¿æŒ $0/æœˆ çš„è¿è¥æˆæœ¬ï¼**

**ä¸“å®¶å»ºè®®:** ä¸è¦ä¸ºäº† Cron å»å‡çº§ Vercel Pro ($20/mo)ã€‚å¯¹äº"ä¸€äººå…¬å¸"åˆ›ä¸šè€…ï¼Œæ¯åˆ†é’±éƒ½è¦èŠ±åœ¨åˆ€åˆƒä¸Šã€‚Upstash çš„å…è´¹é¢åº¦è¶³ä»¥æ”¯æ’‘æ‚¨ç›‘æ§ 50 ä¸ªä»¥ä¸Šçš„ç½‘ç«™ã€‚










